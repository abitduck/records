---
layout: post
title: 以两军问题为背景来演绎BasicPaxos
tags:
- paxos
categories: paxos
description: phxpaxos原理
---


Paxos协议是分布式系统设计中的一个非常重要的协议，本文转载自[微信后台团队公众号团队所发表一系列Paxos的文章](https://mp.weixin.qq.com/s/WEi2kojApSP8PBupdP_8yw)，中间针对自己的理解略有修改或注释。在此处做一个备份，一方面为了加深对Paxos协议的理解，另一方面也方便自己的后续查找，防止文章丢失。


<!-- more -->

## 1. 背景
在计算机通信理论中，有一个著名的两军问题，讲述通信的双方通过ACK来达成共识，永远会有一个在途的ACK需要进行确认，因此无法达成共识。

两军问题和BasicPaxos非常相似：

>1) 通信的各方需要达成共识
>
>2) 通信的各方仅需达成一个共识
>
>3) 假设信道不稳定，有丢包、延迟或者重放，但消息不会被篡改

BasicPaxos最早以希腊会议为背景来讲解，但普通人不理解希腊会议的运作模式，因此看BasicPaxos的论文会比较难理解。两军问题的背景大家更熟悉，因此尝试用这个背景来演绎一下BasicPaxos。

为了配合BasicPaxos的多数派概念，把两军改为3军；同时假设了将军、参谋和通信兵的角色。

###### 假设的3军问题

![paxos-three](https://ivanzz1001.github.io/records/assets/img/paxos/paxos_three.jpeg)

>1) 1支红军在山谷里扎营，在周围的山坡上驻扎着3支蓝军；
>
>2) 红军比任意1支蓝军都要强大： 如果1支蓝军单独作战，红军胜； 如果2支或以上蓝军同时进攻，蓝军胜；
>
>3) 三支蓝军需要同步他们的进攻时间，但他们唯一的通信媒介是派通信兵步行进入山谷，在那里它们可以被俘虏，从而将信息丢失；或者为了避免俘虏，可能在山谷间停留很长时间；
>
>4) 每支军队有1个参谋负责提议进攻时间，每支军队也有1个将军批准参谋提出的进攻时间，很明显，1个参谋提出的进攻时间需要获得至少2个将军的批准才有意义；
>
>5) 问题： 是否存在一个协议，能够使得蓝军同步他们的进攻时间？


接下来以两个假设的场景来演绎BasicPaxos，参谋和将军需要遵循一些基本的规则：

>1) 参谋以两阶段提交（prepare/commit)的方式来发起提议，在prepare阶段需要给出一个编号；
>
>2) 在prepare阶段产生冲突，将军将以编号大小来裁决，编号大的参谋胜出；
>
>3) 参谋在prepare阶段如果收到了将军返回的已接受进攻时间，在commit阶段必须使用这个返回的进攻时间；

###### 两个参谋先后提议的场景

![paxos-sit](https://ivanzz1001.github.io/records/assets/img/paxos/paxos_situation.jpeg)
下面我们描述一下整个过程：

>1） 参谋1发起提议，派通信兵带信给3个将军，内容为（编号1）
>
>2） 3个将军收到参谋1的提议，由于之前没有保存任何编号，因此把(编号1）保存下来，避免遗忘，同时让通信兵带信回去，内容为(ok)
>
>3) 参谋1收到至少2个将军的回复，再次派通信兵带信给3个将军，内容为(编号1，进攻时间1）；
>
>4) 3个将军收到参谋1的时间，把（编号1，进攻时间1）保存起来，避免遗忘，同时让通信兵带信回去，内容为(Accepted)
>
>5) 参谋1收到至少两个将军(Accepted)内容，确认进攻时间已经被大家接收
>
>
>6） 参谋2发起提议，派通信兵带信给3个将军，内容为（编号2）
>
>7） 3个将军收到参谋2的提议，由于（编号2）比（编号1）大，因此把（编号2）保存下来，避免遗忘。又由于之前已经接受参谋1的提议，因此让通信兵带信回去，内容为（编号1，进攻时间1）；
>
>8） 参谋2收到将军的回复，由于回复中带来了已接受的参谋1的提议内容，参谋2因此不能再提出新的进攻时间，接受参谋1提出的时间。参谋>2再次派通信并给3个将军，内容为（编号2，进攻时间1）
>
>9） 3个将军收到参谋2的时间，把（编号2，进攻时间1）保存下来，避免遗忘，同时让通信兵带信回去，内容为（Accepted）
>
>10） 参谋2收到至少2个将军的(Accepted)内容，确认进攻时间已经被大家接收

###### 两个参谋交叉提议的场景
![paxos-two](https://ivanzz1001.github.io/records/assets/img/paxos/paxos_two.jpeg)

下面我们描述一下整个过程：

>1) 参谋1发起提议，派通信兵带信给3个将军，内容为（编号1）
>
>2) 3个将军的情况如下
>   a. 将军1和将军2收到参谋1的提议，因为还没有其他参谋提议，因此将军1和将军2把(编号1）记录下来；同时让通信兵带信回去，内容为>      (OK)
>   b. 负责通知将军3的通信兵被抓，因此将军3没有收到参谋1的提议；
>   
>
>3) 参谋2在同一时间也发起了提议，派通信兵带信给3个将军，内容为（编号2）
>
>4) 3个将军的情况如下
>   a. 将军2和将军3收到参谋2的提议，将军2和将军3把(编号2）记录下来；将军2记录编号2，是因为编号2比之前记录的编号1大； 将军3
>      录编号2，是因为之前没有参谋向他提议。这两个将军同时让通信兵带信回去，内容为(OK)
>   b. 负责通知将军1的通信兵被抓，因此将军1没有收到参谋2的提议；
>      
>
>5) 




<br />
<br />
**参看：**

1. [Paxos从理论到实践](https://mp.weixin.qq.com/s/WEi2kojApSP8PBupdP_8yw?)

<br />
<br />
<br />


