---
layout: post
title: ceph网络通信
tags:
- ceph
categories: ceph
description: ceph源代码分析
---

本章我们介绍一下Ceph的网络通信模块，这是客户端和服务器通信的底层模块，用来在客户端和服务器之间接收和发送请求。其实现功能比较清晰，是一个相对比较独立的模块，理解起来比较容易。

<!-- more -->


## 1. Ceph网络通信框架
一个分布式存储系统需要一个稳定的底层网络通信模块，用于各节点之间互联互通。对于一个网络通信系统，要求如下：

* 高性能。性能评价的两个指标：```带宽```和```延迟```

* 稳定可靠。数据不丢包，在网络中断时，实现重连等异常处理。

网络通信模块实现的源代码在src/msg目录下，其首先定义了一个网络通信的框架，三个子目录里分别对应：Simple、Async、XIO三种不同的实现方式。

Simple是比较简单，目前比较稳定的实现，系统默认的用于生产环境的方式。它最大的特点是：每一个网络连接都会创建两个线程，一个专门用于接收，一个专门用于发送。这种模式实现比较简单，但是对于大规模的集群部署，大量的连接会产生大量的线程，会消耗CPU资源，影响性能。

Async模式使用了基于事件的IO多路复用模式。这是网络通信中广泛采用的方式。但是在Ceph中，官方宣称这种方式还处于试验阶段，不够稳定，还不能用于生产环境。

XIO方式使用了开源的网络通信库```accelio```来实现。这种方式需要依赖第三方的库accelio的稳定性，需要对accelio的使用方式以及代码都比较熟悉。目前也处于试验阶段。特别注意的是，前两种方式只支持TCP/IP协议，而XIO可以支持Infiniband网络。

在msg目录下定义了网络通信的抽象框架，它完成了通信接口和具体实现的分离。在其下分别由msg/simple子目录、msg/async子目录、msg/xio子目录，分别对应三种不同的实现。


### 1.1 Message
类Message是所有消息的基类(位于：src/msg/message.cc)，任何要发送的消息，都要继承该类，格式如下图3-1所示：

![ceph-chapter3-1](https://ivanzz1001.github.io/records/assets/img/ceph/sca/ceph_chapter3_1.jpg)




<br />
<br />

**[参看]**

1. [非常详细的 Ceph 介绍、原理、架构](https://blog.csdn.net/mingongge/article/details/100788388)





<br />
<br />
<br />

