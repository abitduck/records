---
layout: post
title: 使用LVS实现负载均衡
tags:
- lb
categories: lb
description: 使用LVS实现负载均衡
---

本文主要讲述一下LVS的基本概念以及相关原理。

<!-- more -->


## 1. LVS简介
LVS是Linux Virtual Server的简写，是章文嵩博士1998年发起的一个开源项目。Internet的快速增长使多媒体网络服务器面对的访问数量快速增加，服务器需要具备提供大量并发访问服务的能力，因此对于大负载的服务器来讲，CPU、IO处理能力很快会成为瓶颈。由于单台服务器的性能总是有限的，简单的提高硬件性能并不能真正解决这个问题。为此，必须采用多服务器和负载均衡技术才能满足大量并发访问的需要。Linux虚拟服务器（Linux Virtual Server, LVS)使用负载均衡技术将多台服务器组成一个虚拟服务器。它为适应快速增长的网络访问需求提供了一个负载能力易于扩展，而价格低廉的解决方案。lvs已经集成到Linux 2.6版本以上的内核中。LVS的负载能力特别强，优化空间特别大，lvs的变种DPVS据说是lvs性能的几倍，由爱奇艺开发，并广泛应用于爱奇艺IDC。其他负载均衡服务器还有nginx、haproxy、F5、Netscale。


LVS项目的一个基本目标就是：
<pre>
Build a high-performance and highly available server for Linux using clustering technology, 
which provides good scalability, reliability and serviceability.
</pre>

### 1.1 基本术语
我们在后续讲解LVS的过程中经常会涉及到一些术语，为方便理解及查阅，先在这里进行简单说明：

* IPVS, ipvs, ip_vs: director主机上Linux内核的补丁代码

* LVS, linux virtual server: 包括director和realservers。所有这些主机的集合称为virtual server，以透明的方式对外部终端(clients)提供服务

* director: 运行ipvs代码的节点。客户端(clients)连接到director，然后其将接收到的数据包转发给real servers。这里director其实只是一个拥有一些特定规则的IP路由(ip router)。

* realservers: 提供服务的主机，用于实际处理来自于客户端的请求

* client: 连接到director VIP地址的客户端主机或应用程序

* forwarding method: 转发方法（LVS-NAT,LVS-DR， LVS-Tun)。与普通的ip router相比, director的转发规则有些不同。**forwarding method**用于决定director如何将来自于client的数据包转发到realservers。

* scheduling: director选择一台realserver的算法

### 1.2 virtual services, scheduling groups
如下是一个提供telnet和squid服务的LVS输出：
{% highlight string %}
# ipvsadm
IP Virtual Server version 0.9.4 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  lvs.mack.net:squid rr
  -> rs1.mack.net:squid        Route   1      0          0
  -> rs2.mack.net:squid        Route   1      0          0
  -> rs3.mack.net:squid        Route   1      0          0
TCP  lvs.mack.net:telnet rr
  -> rs1.mack.net:telnet       Route   1      0          0
  -> rs2.mack.net:telnet       Route   1      0          0
{% endhighlight %}
上面的LVS提供两种```虚拟服务```(virtual services): telnet和squid。对应两台虚拟服务器(virtual servers)，其中一台虚拟服务器用于提供telnet服务（拥有2台realservers)，另一台用于提供squid服务（拥有3台realservers)。对于客户端来说，看到的就是2个服务(services)，2台服务器(servers)

发送到每台虚拟服务器(virtual server)的请求都通过相应的策略（这里是rr，即round robin)转发到其所在调度组(scheduling group)的realservers上。这里对于telnet服务，其scheduling group对应rs1、rs2； 对于squid服务，其scheduling group对应rs1、rs2、rs3。telnet虚拟主机与squid虚拟主机的调度策略是相互独立的。

对于上面这样一种lvs配置可被扩展用于[firewall mark(fwmark)](http://www.austintek.com/LVS/LVS-HOWTO/HOWTO/LVS-HOWTO.fwmark.html#LVS-HOWTO.fwmark)。

### 1.3 LVS中的IPs/networks命名

![lb-lvs-names](https://ivanzz1001.github.io/records/assets/img/lb/lb_lvs_names.jpg)



<br />
<br />

**[参看]**

1. [使用LVS实现负载均衡原理及安装配置详解](https://www.cnblogs.com/liwei0526vip/p/6370103.html)

2. [Linux服务器集群系统](http://www.linuxvirtualserver.org/zh/lvs4.html)

3. [lvs官网](http://www.linuxvirtualserver.org/whatis.html)

4. [Keepalived+LVS负载均衡实现](https://blog.csdn.net/mr_rsq/article/details/80466389)

5. [LVS原理详解以及部署](https://www.cnblogs.com/dswy/p/8418515.html)

<br />
<br />
<br />


