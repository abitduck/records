---
layout: post
title: IO系统性能之一：衡量性能的几个指标（转）
tags:
- LinuxOps
categories: linuxOps
description: 磁盘IO性能指标
---


作为一个数据库管理员，关注系统的性能是日常最重要的工作之一，而在所关注的各方面的性能中， IO性能却是最令人头痛的一块，面对着各种生涩的参数和令人眼花缭乱的新奇术语，再加上存储厂商的忽悠，总是让我们有种云里雾里的感觉。本系列文章试图从基本概念开始对磁盘存储相关的各种概念进行综合归纳，让大家能够对IO性能相关的基本概念，IO性能的监控和调整有个比较全面的了解。


在这一部分里我们先舍弃各种结构复杂的存储系统，直接研究一个单独的磁盘的性能问题，藉此了解衡量IO系统性能的各个指标以及之间的关系。需要注意的是，本文探讨的仅限于磁盘IO性能，网络IO性能不考虑在内。


<!-- more -->


## 1. 几个基本概念
在研究磁盘性能之前，我们必须先了解磁盘的结构，以及工作原理。不过在这里就不再重复说明了，关于```磁盘结构```和```工作原理```的信息可以参考维基百科上面的相关词条————Hard disk drive(英文)和硬盘驱动器(中文）


1） **读写IO(Read/Write IO)操作**

磁盘是用来给我们存取数据用的，因此当说到IO操作的时候，就会存在两种相对应的操作，```存数据```时候对应的是写IO操作，```取数据```时候对应的是读IO操作。

2) **单个IO操作**

当控制磁盘的控制器接到操作系统的```读IO操作```指令的时候，控制器就会给磁盘发出一个读数据的指令，并同时将要读取的数据块的地址传递给磁盘，然后磁盘会将读取到的数据传给控制器，并由控制器返回给操作系统，完成一个读IO的操作。同样的，一个写IO的操作也类似，控制器接到```写IO操作```的指令和要写入的数据，并将其传递给磁盘，磁盘在数据写入完成之后将操作结果传递回控制器，再由控制器返回给操作系统，完成一个写IO的操作。单个IO操作指的就是完成一个写IO或者读IO的操作。


3) **随机访问(Random Access)与顺序访问(Sequential Access)**

随机访问指的是本次IO所给出的扇区地址和上次IO给出的扇区地址相差比较大，这样的话磁头在两次IO操作之间需要作比较大的移动操作才能重新开始读/写数据。相反的，如果当次IO给出的扇区地址与上次IO结束时的扇区地址一致或者是接近的话，那么磁头就能很快的开始这次IO操作，这样的多个IO操作称为连续访问。因此，尽管相邻的两次IO操作在同一时刻发出，但如果他们请求的扇区地址相差很大的话也只能称为随机访问，而非顺序访问。

4) **顺序IO模式(Queue Mode)与并发IO模式(Burst Mode)**

磁盘控制器可能会一次对磁盘组发出一连串的IO指令，如果磁盘组一次只能执行一个IO指令时称为顺序IO; 当磁盘组能同时执行多个IO指令时，称为并发IO。并发IO只能发生在由多个磁盘组成的磁盘组上，单块磁盘只能一次处理一个IO命令。


## 2. 单个IO的大小(IO Chunk Size)

熟悉数据库的人都会有这么一个概念，那就是数据库存储有个基本的块大小(Block Size)，不管是SQL Server还是Oracle，默认的块大小都是8KB，就是数据库每次读写都是以8KB为单位来进行的。那么对于数据库应用发出的固定8KB大小的单次读写，到了磁盘这一层面会是怎么样的情况呢？ 就是对于读写磁盘来说，单个IO操作操作数据的大小是多少呢， 是不是也是一个固定的值？

答案是不确定。首先操作系统为了提高IO的性能而引入了文件系统缓存(File System Cache)，系统会根据请求数据的情况将多个来自IO的请求先放在缓存里面，然后再一次性的提交给磁盘，也就是说对于数据库发出的多个8K数据块的读操作，有可能放在一个磁盘读IO里就处理了。

还有对于有些存储系统也是提供了缓存(Cache)的，接收到操作系统的IO请求之后，也是会将多个操作系统的IO请求合并成一个来处理。不管是操作系统层面的缓存还是磁盘控制器层面的缓存，目的都只有一个，提高数据读写的效率。因此，每次单独的IO操作大小都是不一样的，它主要取决于系统对于数据读写效率的判断。

当一次IO操作大小比较小的时候，我们称为小的IO操作。比如说1K、4K、8K这样的；当一次IO操作的数据量比较大的时候，我们称为大IO操作，比如32K、64K甚至更大。

在我们说道块大小(Block Size)的时候，通常我们会接触到多个类似的概念，像我们上面提到的那个在数据库里面的数据最小管理单元， Oracle称之为块(Block)，大小一般为8K， SQL Server称之为页(Page)，一般大小也为8K。

在文件系统里面，我们也能碰到一个文件系统的块(Block)。在现在很多的Linux系统中都是4K，它的作用其实跟数据库里面的块/页是一样的，都是为了方面数据管理。但是说道单次IO的大小，跟这些块的大小都是没有直接关系的，在英文里单次IO大小通常被称为IO Chunk Size，不会说成IO Block Size的。


## 3. IOPS(IO per Second)
IOPS是指IO系统每秒所执行IO操作的次数，是一个重要的用来衡量系统IO能力的一个参数。对于单个磁盘组成的IO系统来说，计算它的IOPS不是一件很难的事情，只要我们知道了系统完成一次IO所需要的时间的话，我们就能推算出系统IOPS来。

现在我们就来推算一下磁盘的IOPS，假设磁盘的转速(Rotational Speed)为15K RPM，平均寻道时间为5ms，最大传输速率为40MB/s（这里将读写速度视为一样，实际会差别比较大）。

对于磁盘来说一个完整的IO操作是这样进行的： 当控制器对磁盘发出一个IO操作命令的时候，磁盘的驱动臂(Actuator Arm)带读写磁头(Head)离开着陆区(Landing Zone，位于内圈没有数据的区域)，移动到要操作的初始数据块所在的磁道(Track)的正上方，这个过程被称为寻道(Seeking),对应消耗的时间被称为```寻道时间```(Seek Time)； 但是找到对应磁道还不能马上读取数据，这时候磁头要等到磁盘盘片(Platter)旋转到初始数据块所在扇区(Sector)落在读写磁头正上方之后才能开始读写数据，在这个等待盘片旋转到可操作扇区的过程中消耗的时间称为```旋转延时```(Rotational Delay); 接下来就随着盘片的旋转，磁头不断的读/写相应的数据块，直到完成这次IO所需要操作的全部数据，这个过程称为数据传送(Data Transfer)，对应的时间称为```传送时间```(Transfer Time)。完成这三个步骤之后，一次IO操作也就完成了。

<pre>
Total = 寻道时间 + 旋转延迟 + 传送时间
</pre>

在我们看硬盘厂商的宣传单的时候，我们经常能看到3个参数，分别是平均寻址时间、盘片旋转速度以及最大传送速度，这三个参数就可以提供给我们计算上述三个步骤的时间。

1） 第一个寻址时间，考虑到被读写的数据可能在磁盘的任意一个磁道，既有可能在磁盘的最内圈(寻址时间最短），也可能在磁盘的最外圈（寻址时间最长），所以在计算中我们只考虑平均寻址时间，也就是磁盘参数中标明的那个平均```寻址时间```,这里就采用当前最多的```15K RPM```硬盘的5ms。

2) 第二个旋转延时，和寻址一样，当磁头定位到磁道之后有可能正好在要读写扇区之上，这时候是不需要额外延时就可以立刻读写到数据，但是最坏的情况却是要磁盘旋转整整一圈之后磁头才能读取到数据，所以这里我们也考虑的是平均旋转延时，对于```15K RPM```的磁盘就是(60s/15K)/2 = 2ms。(磁盘转速单位一般为： 转/每分钟）

3） 第三个传送时间，磁盘参数提供给我们的最大传输速度，当然要达到这种速度是很有难度的，但是这个速度却是```纯读写磁盘```的速度，因此只要给定了单次IO的大小，我们就知道磁盘需要花费多少时间在数据传送上，这个时间就是IO Chunk Size /Max Transfer Rate。 

## 4. IOPS计算公式




<br />
<br />

**[参看]:**


1. [IO系统性能之一：衡量性能的几个指标](https://www.cnblogs.com/94cool/p/5662256.html)

2. [如何让linux服务器磁盘io性能翻倍](http://blog.chinaunix.net/uid-29873073-id-4549595.html)

<br />
<br />
<br />


