---
layout: post
title: IP数据包经过路由器后的变化
tags:
- network
categories: network
description: IP数据包经过路由器后的变化
---

本章介绍一下IP数据包经过路由器的过程。

<!-- more -->


## 1. 路由器转发IP数据包

关于路由器转发IP数据包过程中```MAC地址```和```IP地址```变与不变的问题，我们先给出如下结论：MAC地址在同一个广播域传输过程中是不变的，在跨越广播域的时候会发生改变；而IP地址在传输过程中是不会改变的（除NAT的时候）。

关于MAC与IP，我们还要知道：

* MAC地址是用于同一物理或逻辑第2层网络上的设备间进行通信的；

* IP地址是可以在多个网络设备之间通信的；

### 1.1 目的MAC地址是如何得到的？
TCP/IP里面采用ARP协议来获取MAC地址。比如新建了一个内网，如果一台机器A找机器B，封装```FRAME```时(OSI的第二层用的数据格式），要封装对方的MAC，开始时A不知道B的MAC地址，只知道IP，因此它就发送一个ARP包，源IP是自己的，目的IP是B的，源MAC是自己的，目的MAC是广播的。然后这个请求包在内网中被广播，当其他机器接收到这个包时，用目的IP和自己的IP进行比较，不是的话就丢弃。B接到时，发现IP与自己的一样，就应答这个包的请求，把自己的MAC发送给A。如果B是其他子网的机器，那么路由器会判断出B是其他子网，然后路由器把自己的MAC返回给A，A以后再给B发包时，目的MAC封装的是路由器的。


### 1.2 路由转发过程

当主机A发向主机B的数据流在网络层封装成IP数据包，IP数据包的首部包含了源地址和目标地址。主机A会用本机配置的24位IP网络掩码255.255.255.0与目标地址进行与运算，得出目标网络地址与本机的网络地址是不是在同一个网段中。如果不是就将IP数据包转发到网关。

在发往网关前主机A还会通过ARP的请求获得默认网关的MAC地址。在主机A数据链路层IP数据包封装成以太网数据帧，然后才发往到网关...，也就是路由器上的一个端口。

当网关路由器接收到以太网数据帧时，发现数据帧中的目标MAC地址是自己的某一个端口的物理地址，这时路由器会把以太网数据帧的封装去掉。路由器认为这个IP数据包是要通过自己进行转发，接着它就在匹配路由表。匹配到路由项后，它就将包发往下一跳地址。


路由器转发数据包就是这样，所以它始终是不会改IP地址的，只会更改MAC。

当有数据包传到路由器时，路由器首先将其目的地址与路由表进行对比，如果是本地网络，将不会进行转发到外网络，而是直接转发给本地网关内的目的主机；但是如果目的地址经路由表对比，发现不是在本网中，有NAT就将改变源地址的IP（原源地址的IP改为路由器的IP地址），路由器将数据包转发到相应的端口，进行通信。

### 1.3 案例分析

MAC地址是在同一个广播域有效的，那么去了另外一个广播域（网段）MAC地址肯定要改变的。

在同一个广播域中数据帧的mac地址是不会变的，因为所有交换机应该都知道该广播域中的所有主机的MAC地址（如果不知道，会通过被动广播的方式来学习到）。既然知道所有的MAC地址，那么当交换机收到数据帧的时候就看一下目标MAC地址，然后对照一下MAC地址表，从对应的接口发送出去即可。

IP地址是在整个网络中有效的，整个Internet网络就相当于是一个大的地图，同样知道所有的IP地址如何到达，那么在传输过程中源IP和目的IP也是不会改变的。当路由器接收到数据包的时候，检查数据包的目的IP地址，然后查找路由表（路由转发表），选择合适的接口发出去。

![route-theory](https://ivanzz1001.github.io/records/assets/img/network/route_theory_1.jpg)

上图中A-R4-R2-B假设有数据帧X，传输过程如下：
<pre>
A到R4: MAC地址(存在的话)源地址是A，目的地址是R4;

R4到R2: MAC地址(存在的话)源地址是R4，目的地址是R2;

R2到B: MAC地址(存在的话)源地址是R2，目的地址是B； 
</pre>

在没有经过NAT的情况下，源IP地址和目的IP地址在整个传输过程是不能改变的。

## 2. SNAT与DNAT

在LInux操作系统中，Netfilter组件是集成在Linux内核中扩展各种网络服务的结构化底层框架，在内核级提供防火墙功能。内核中选取五个位置放了五个hook(钩子) function(INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING)，而这五个hook function向用户开放，用户可以通过一个命令工具(iptables)向其写入规则。

![linux-netfilter](https://ivanzz1001.github.io/records/assets/img/network/linux-netfilter.jpg)

报文流向：

* 流入本机：PREROUTING -> INPUT -> 用户进程空间

* 流出本机: 用户进程空间 -> OUTPUT -> POSTROUTING

* 转发: PREROUTING -> FORWARD -> POSTROUTING

内核中数据包的传输过程：

1) 当一个数据包进入网卡时，数据包首先进入PREROUTING链，内核根据数据包的目的IP判断是否需要转送出去；

2) 如果数据包就是进入本机的，数据包就会到达INPUT链。经过INPUT链检查后，数据包被发往本地进程。本地进程经过相应处理后发送响应数据包，数据包经过OUTPUT链，然后到达POSTROUTING链输出；如果数据包是要转发出去的，且内核允许转发，数据包就会向右移动，经过FORWARD链，然后到达POSTROUTING链输出。

企业内部的主机A若配置了一个公网地址6.6.6.6，访问互联网上其他网络的公有地址不受限制，但若访问互联网上同网段的地址（即6.0.0.0/8网段的地址），由于A的路由表就有到达该网段的路由记录，就直接访问了，不会去查询路由器，但是实际上访问的不是互联网上的主机，而是本地局域网的主机，也就是说该网段的所有公有地址A都将无法访问。所以企业内部的主机一般是私有地址，但是互联网上没有私有地址的路由，也就是说私有地址无法连接互联网，可以利用防火墙的NAT表(network address translation地址转换规则表）将私有地址转换为公有地址再去访问互联网。

### 2.1 SNAT


<br />
<br />

**参考**:

1. [网络-数据包在路由转发过程中MAC地址和IP地址，变与不变](https://www.cnblogs.com/JohnABC/p/5918154.html)

2. [ip数据包经由路由转发的时候源ip，目的ip是否改变](https://blog.csdn.net/gao1440156051/article/details/51213898)

3. [SNAT与DNAT](https://blog.csdn.net/beanewself/article/details/78317626)


<br />
<br />
<br />

